<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ラベルチェックアプリ 商品マスタ管理 v1.2.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="/__/firebase/10.12.2/firebase-app-compat.js"></script>
    <script src="/__/firebase/10.12.2/firebase-auth-compat.js"></script>
    <script src="/__/firebase/10.12.2/firebase-firestore-compat.js"></script>
    <script src="/__/firebase/10.12.2/firebase-functions-compat.js"></script>
    <script src="/__/firebase/init.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .toast {
            position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem;
            border-radius: 0.5rem; color: white; opacity: 0;
            transition: opacity 0.3s ease-in-out; z-index: 100;
        }
        .toast.show { opacity: 1; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .thumbnail { width: 60px; height: 60px; object-fit: cover; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .autocomplete-container { position: relative; }
        .autocomplete-items {
            position: absolute; border: 1px solid #d1d5db; border-top: none; z-index: 99;
            top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto;
            background-color: #fff;
        }
        .autocomplete-items div { padding: 10px; cursor: pointer; }
        .autocomplete-items div:hover { background-color: #e5e7eb; }
        .autocomplete-active { background-color: DodgerBlue !important; color: #ffffff; }
        .input-error { border-color: #ef4444 !important; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-6xl my-8 p-4 bg-white shadow-lg rounded-lg">
        <header class="text-center py-4 border-b">
            <h1 class="text-3xl font-bold text-gray-800">商品マスタ管理</h1>
            <p id="db-status-indicator" class="text-sm font-semibold mt-1">データベースに接続中...</p>
        </header>

        <main class="mt-6">
            <section id="add-product-section" class="mb-8 p-6 bg-gray-50 rounded-lg border">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">新規商品を追加</h2>
                
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">1. ラベルを撮影</h3>
                    <input type="file" accept="image/*" capture="environment" id="cameraInput" class="hidden">
                    <button id="takePictureBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-colors">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        ラベルを撮影して自動入力
                    </button>
                    <div id="image-preview-container" class="mt-4 hidden text-center">
                        <img id="imagePreview" src="" class="max-w-xs mx-auto rounded-md border bg-white p-1">
                        <div id="ai-loading" class="mt-2 flex items-center justify-center text-gray-600 hidden">
                            <div class="spinner mr-2"></div>
                            <span>AIがラベルを解析中...</span>
                        </div>
                    </div>
                </div>

                <form id="add-product-form" autocomplete="off" novalidate>
                    <h3 class="text-lg font-medium text-gray-800 mb-2 mt-6">2. 内容を確認・修正して追加</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="productMngId" name="mngId" placeholder="管理番号 (自動入力)" required class="p-3 border border-gray-300 rounded-lg" maxlength="4">
                        <input type="text" id="productName" name="name" placeholder="商品名 (自動入力)" required class="p-3 border border-gray-300 rounded-lg">
                        
                        <div class="autocomplete-container">
                            <input type="text" id="productOrigin" name="origin" placeholder="産地 (自動入力)" required class="p-3 border border-gray-300 rounded-lg w-full">
                        </div>
                        
                        <input type="text" id="productJan" name="jan" placeholder="JANコード (自動入力)" required class="p-3 border border-gray-300 rounded-lg" maxlength="13">
                        <input type="url" id="productLabelImageUrl" name="labelImageUrl" placeholder="ラベル画像URL (任意)" class="p-3 border border-gray-300 rounded-lg md:col-span-2">
                        <button type="submit" id="submit-product-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors md:col-span-2">
                            商品を追加する
                        </button>
                    </div>
                </form>
            </section>

            <section>
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">商品一覧</h2>
                <div id="loading-indicator" class="text-center py-10">
                    <p>商品データを読み込んでいます...</p>
                </div>
                <div class="overflow-x-auto">
                    <table id="product-table" class="min-w-full bg-white hidden">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left">商品ID</th>
                                <th class="py-3 px-4 text-left">管理番号</th>
                                <th class="py-3 px-4 text-left">商品名</th>
                                <th class="py-3 px-4 text-left">産地</th>
                                <th class="py-3 px-4 text-left">JAN</th>
                                <th class="py-3 px-4 text-left">ラベル画像</th>
                                <th class="py-3 px-4 text-left">操作</th>
                            </tr>
                        </thead>
                        <tbody id="product-list" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script type="module">
        const dbStatusIndicator = document.getElementById('db-status-indicator');
        const loadingIndicator = document.getElementById('loading-indicator');
        const productTable = document.getElementById('product-table');
        const productList = document.getElementById('product-list');
        const addProductForm = document.getElementById('add-product-form');
        const submitProductBtn = document.getElementById('submit-product-btn');
        const toastNotification = document.getElementById('toast-notification');
        const cameraInput = document.getElementById('cameraInput');
        const takePictureBtn = document.getElementById('takePictureBtn');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('imagePreview');
        const aiLoading = document.getElementById('ai-loading');
        const productMngIdInput = document.getElementById('productMngId');
        const productOriginInput = document.getElementById('productOrigin');
        const productJanInput = document.getElementById('productJan');

        const prefectures = [
            {kanji: "北海道", hiragana: "ほっかいどう", romaji: "hokkaido"}, {kanji: "青森県", hiragana: "あおもりけん", romaji: "aomori"},
            {kanji: "岩手県", hiragana: "いわてけん", romaji: "iwate"}, {kanji: "宮城県", hiragana: "みやぎけん", romaji: "miyagi"},
            {kanji: "秋田県", hiragana: "あきたけん", romaji: "akita"}, {kanji: "山形県", hiragana: "やまがたけん", romaji: "yamagata"},
            {kanji: "福島県", hiragana: "ふくしまけん", romaji: "fukushima"}, {kanji: "茨城県", hiragana: "いばらきけん", romaji: "ibaraki"},
            {kanji: "栃木県", hiragana: "とちぎけん", romaji: "tochigi"}, {kanji: "群馬県", hiragana: "ぐんまけん", romaji: "gunma"},
            {kanji: "埼玉県", hiragana: "さいたまけん", romaji: "saitama"}, {kanji: "千葉県", hiragana: "ちばけん", romaji: "chiba"},
            {kanji: "東京都", hiragana: "とうきょうと", romaji: "tokyo"}, {kanji: "神奈川県", hiragana: "かながわけん", romaji: "kanagawa"},
            {kanji: "新潟県", hiragana: "にいがたけん", romaji: "niigata"}, {kanji: "富山県", hiragana: "とやまけん", romaji: "toyama"},
            {kanji: "石川県", hiragana: "いしかわけん", romaji: "ishikawa"}, {kanji: "福井県", hiragana: "ふくいけん", romaji: "fukui"},
            {kanji: "山梨県", hiragana: "やまなしけん", romaji: "yamanashi"}, {kanji: "長野県", hiragana: "ながのけん", romaji: "nagano"},
            {kanji: "岐阜県", hiragana: "ぎふけん", romaji: "gifu"}, {kanji: "静岡県", hiragana: "しずおかけん", romaji: "shizuoka"},
            {kanji: "愛知県", hiragana: "あいちけん", romaji: "aichi"}, {kanji: "三重県", hiragana: "みえけん", romaji: "mie"},
            {kanji: "滋賀県", hiragana: "しがけん", romaji: "shiga"}, {kanji: "京都府", hiragana: "きょうとふ", romaji: "kyoto"},
            {kanji: "大阪府", hiragana: "おおさかふ", romaji: "osaka"}, {kanji: "兵庫県", hiragana: "ひょうごけん", romaji: "hyogo"},
            {kanji: "奈良県", hiragana: "ならけん", romaji: "nara"}, {kanji: "和歌山県", hiragana: "わかやまけん", romaji: "wakayama"},
            {kanji: "鳥取県", hiragana: "とっとりけん", romaji: "tottori"}, {kanji: "島根県", hiragana: "しまねけん", romaji: "shimane"},
            {kanji: "岡山県", hiragana: "おかやまけん", romaji: "okayama"}, {kanji: "広島県", hiragana: "ひろしまけん", romaji: "hiroshima"},
            {kanji: "山口県", hiragana: "やまぐちけん", romaji: "yamaguchi"}, {kanji: "徳島県", hiragana: "とくしまけん", romaji: "tokushima"},
            {kanji: "香川県", hiragana: "かがわけん", romaji: "kagawa"}, {kanji: "愛媛県", hiragana: "えひめけん", romaji: "ehime"},
            {kanji: "高知県", hiragana: "こうちけん", romaji: "kochi"}, {kanji: "福岡県", hiragana: "ふくおかけん", romaji: "fukuoka"},
            {kanji: "佐賀県", hiragana: "さがけん", romaji: "saga"}, {kanji: "長崎県", hiragana: "ながさきけん", romaji: "nagasaki"},
            {kanji: "熊本県", hiragana: "くまもとけん", romaji: "kumamoto"}, {kanji: "大分県", hiragana: "おおいたけん", romaji: "oita"},
            {kanji: "宮崎県", hiragana: "みやざきけん", romaji: "miyazaki"}, {kanji: "鹿児島県", hiragana: "かごしまけん", romaji: "kagoshima"},
            {kanji: "沖縄県", hiragana: "おきなわけん", romaji: "okinawa"}
        ];
        const prefectureKanjiNames = prefectures.map(p => p.kanji.replace(/[県府都]$/, ''));
        
        let db, functions;

        function showToast(message, isSuccess = true) {
            toastNotification.textContent = message;
            toastNotification.className = `toast show ${isSuccess ? 'success' : 'error'}`;
            setTimeout(() => { toastNotification.classList.remove('show'); }, 3000);
        }

        async function analyzeLabelWithAI(base64ImageData) {
            const analyzeLabel = firebase.functions().httpsCallable('analyzeLabel');
            try {
                const result = await analyzeLabel({ imageData: base64ImageData });
                return result.data;
            } catch (error) {
                console.error("Cloud Functionの呼び出しに失敗:", error);
                throw new Error("AI解析サーバーとの通信に失敗しました。");
            }
        }

        function renderProductList(products) {
            productList.innerHTML = '';
            if (products.length === 0) {
                loadingIndicator.textContent = '商品が登録されていません。';
                loadingIndicator.classList.remove('hidden');
                productTable.classList.add('hidden');
                return;
            }

            products.forEach(product => {
                const tr = document.createElement('tr');
                const imageUrl = product.labelImageUrl ? `<img src="${product.labelImageUrl}" alt="${product.name}" class="thumbnail rounded">` : 'なし';
                tr.innerHTML = `
                    <td class="py-4 px-4 whitespace-nowrap">${product.id}</td>
                    <td class="py-4 px-4 whitespace-nowrap">${product.mngId}</td>
                    <td class="py-4 px-4 whitespace-nowrap font-medium">${product.name}</td>
                    <td class="py-4 px-4 whitespace-nowrap">${product.origin}</td>
                    <td class="py-4 px-4 whitespace-nowrap">${product.jan}</td>
                    <td class="py-4 px-4">${imageUrl}</td>
                    <td class="py-4 px-4 whitespace-nowrap">
                        <button data-id="${product.docId}" class="delete-btn text-red-500 hover:text-red-700">削除</button>
                    </td>
                `;
                productList.appendChild(tr);
            });

            loadingIndicator.classList.add('hidden');
            productTable.classList.remove('hidden');
        }

        async function loadProducts() {
            try {
                loadingIndicator.classList.remove('hidden');
                productTable.classList.add('hidden');
                
                const q = firebase.firestore().collection("products").orderBy("id");
                const querySnapshot = await q.get();
                const products = querySnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                
                renderProductList(products);
            } catch (error) {
                console.error("商品データの読み込みに失敗:", error);
                showToast("商品データの読み込みに失敗しました。", false);
                loadingIndicator.textContent = '商品データの読み込みに失敗しました。';
            }
        }
        
        function setupAutocomplete(inputEl, arr) {
            let currentFocus;
            inputEl.addEventListener("input", function(e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false;}
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);
                
                for (i = 0; i < arr.length; i++) {
                    const pref = arr[i];
                    if (pref.kanji.startsWith(val) || pref.hiragana.startsWith(val) || pref.romaji.startsWith(val.toLowerCase())) {
                        b = document.createElement("DIV");
                        b.innerHTML = `<strong>${pref.kanji.substr(0, val.length)}</strong>${pref.kanji.substr(val.length)}`;
                        b.innerHTML += `<input type='hidden' value='${pref.kanji}'>`;
                        b.addEventListener("click", function(e) {
                            inputEl.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inputEl) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        function initializeEventListeners() {
            takePictureBtn.addEventListener('click', () => cameraInput.click());

            cameraInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageUrl = e.target.result;
                    imagePreview.src = imageUrl;
                    imagePreviewContainer.classList.remove('hidden');
                    aiLoading.classList.remove('hidden');
                    
                    try {
                        const base64ImageData = imageUrl.split(',')[1];
                        const extractedData = await analyzeLabelWithAI(base64ImageData);
                        
                        if (extractedData) {
                            productMngIdInput.value = extractedData.mngId || '';
                            document.getElementById('productName').value = extractedData.productName || '';
                            productOriginInput.value = (extractedData.origin || '').replace(/産$/, ''); 
                            productJanInput.value = extractedData.janCode || '';
                            showToast("ラベル情報を自動入力しました。");
                        } else {
                           showToast("AIが情報を抽出できませんでした。手動で入力してください。", false);
                        }
                    } catch (error) {
                        console.error("AI解析エラー:", error);
                        showToast(`AI解析中にエラーが発生しました: ${error.message}`, false);
                    } finally {
                        aiLoading.classList.add('hidden');
                    }
                };
                reader.readAsDataURL(file);
            });

            productMngIdInput.addEventListener('blur', (e) => {
                const value = e.target.value;
                if (value && value.length < 4) {
                    e.target.value = value.padStart(4, '0');
                }
            });
            
            productJanInput.addEventListener('input', (e) => {
                const value = e.target.value;
                e.target.value = value
                    .replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                    .replace(/[^0-9]/g, '');
            });

            addProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const inputs = {
                    mngId: productMngIdInput,
                    name: document.getElementById('productName'),
                    origin: productOriginInput,
                    jan: productJanInput,
                };

                let isValid = true;
                Object.values(inputs).forEach(input => input.classList.remove('input-error'));

                let janValue = inputs.jan.value
                    .replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                    .replace(/[^0-9]/g, '');
                inputs.jan.value = janValue;

                let mngIdValue = inputs.mngId.value.padStart(4, '0');
                inputs.mngId.value = mngIdValue;
                
                let originValue = inputs.origin.value.replace(/産$/, '');
                inputs.origin.value = originValue;

                if (janValue.length !== 13) {
                    showToast("JANコードは13桁の半角数字で入力してください。", false);
                    inputs.jan.classList.add('input-error');
                    isValid = false;
                }
                
                const finalOrigin = originValue.replace(/[県府都]$/, '');
                if (!prefectureKanjiNames.includes(finalOrigin) && !prefectures.map(p=>p.kanji).includes(originValue)) {
                     showToast("産地は日本の都道府県名を入力してください。", false);
                     inputs.origin.classList.add('input-error');
                     isValid = false;
                }
                
                if (!isValid) return;
                
                submitProductBtn.disabled = true;
                submitProductBtn.textContent = '追加中...';

                try {
                    const productsCollection = firebase.firestore().collection("products");
                    const productsSnapshot = await productsCollection.get();
                    
                    const newIdNumber = productsSnapshot.size + 1;
                    const newProductId = 'p' + String(newIdNumber).padStart(4, '0');

                    const newProduct = {
                        id: newProductId,
                        mngId: mngIdValue,
                        name: inputs.name.value,
                        origin: originValue,
                        jan: janValue,
                        labelImageUrl: document.getElementById('productLabelImageUrl').value,
                    };

                    await productsCollection.add(newProduct);
                    showToast("商品が正常に追加されました。");
                    addProductForm.reset();
                    imagePreviewContainer.classList.add('hidden');
                    await loadProducts();
                } catch (error) {
                    console.error("商品の追加に失敗:", error);
                    showToast("商品の追加に失敗しました。", false);
                } finally {
                    submitProductBtn.disabled = false;
                    submitProductBtn.textContent = '商品を追加する';
                }
            });

            productList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const docId = e.target.dataset.id;
                    if (confirm("この商品を本当に削除しますか？")) {
                        try {
                            await firebase.firestore().collection("products").doc(docId).delete();
                            showToast("商品を削除しました。");
                            await loadProducts();
                        } catch (error) {
                            console.error("商品の削除に失敗:", error);
                            showToast("商品の削除に失敗しました。", false);
                        }
                    }
                }
            });
            
            setupAutocomplete(productOriginInput, prefectures);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             try {
                if (typeof firebase !== 'undefined' && firebase.app()) {
                    main();
                } else {
                    setTimeout(() => {
                        if (typeof firebase !== 'undefined' && firebase.app()) {
                            main();
                        } else {
                            throw new Error("Firebase is not initialized");
                        }
                    }, 500);
                }
            } catch (e) {
                console.error("Firebaseの初期化に失敗:", e);
                dbStatusIndicator.textContent = 'データベース接続: エラー';
                dbStatusIndicator.classList.add('text-red-600');
                loadingIndicator.textContent = `データベースに接続できませんでした。設定を確認してください。`;
            }
        });

        async function main() {
            try {
                db = firebase.firestore();
                // ★★★ v1.2.2 修正点 ★★★
                // リージョン指定を削除
                functions = firebase.functions();
                const auth = firebase.auth();

                dbStatusIndicator.textContent = 'データベース接続: 正常';
                dbStatusIndicator.classList.add('text-green-600');
                
                await auth.signInAnonymously();
                await loadProducts();
                initializeEventListeners();

            } catch(e) {
                 console.error("メイン処理でエラー:", e);
                 dbStatusIndicator.textContent = 'データベース接続: エラー';
                 dbStatusIndicator.classList.add('text-red-600');
                 loadingIndicator.textContent = `データベースに接続できませんでした。`;
            }
        }
    </script>
</body>
</html>

