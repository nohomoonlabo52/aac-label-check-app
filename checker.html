<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ラベルチェックアプリ v1.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="/__/firebase/10.12.2/firebase-app-compat.js"></script>
    <script src="/__/firebase/10.12.2/firebase-auth-compat.js"></script>
    <script src="/__/firebase/10.12.2/firebase-firestore-compat.js"></script>
    <script src="/__/firebase/10.12.2/firebase-functions-compat.js"></script> <!-- Functions SDK を追加 -->
    <!-- Firebase Init -->
    <script src="/__/firebase/init.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        #cameraInput { display: none; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); width: 24px; height: 24px; border-radius: 50%; border-left-color: #ffffff; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .is-checking { background-color: #9CA3AF; cursor: pointer; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-lg bg-white min-h-screen shadow-lg">
        
        <div id="page-work-list">
            <header class="text-center py-4 border-b">
                <h1 class="text-2xl font-bold text-gray-800">作業指示一覧</h1>
                <p id="db-status-indicator" class="text-sm font-semibold mt-1"></p>
                <p id="current-date" class="text-lg text-gray-600 mt-1"></p>
            </header>
            <main class="p-4">
                <div id="loading-indicator" class="text-center py-10">
                    <p>データを読み込んでいます...</p>
                </div>
                <div id="work-list-container" class="space-y-3 hidden"></div>
            </main>
        </div>

        <div id="page-label-check" class="hidden">
            <header class="text-center py-4 border-b relative">
                <button id="back-to-list-btn" class="absolute left-4 top-1/2 -translate-y-1/2 text-blue-500 hover:text-blue-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h1 class="text-2xl font-bold text-gray-800">ラベルチェック</h1>
            </header>
            <main class="p-4 mt-2">
                <div id="in-work-section">
                    <div class="bg-gray-50 p-4 rounded-lg border mb-6">
                        <p class="text-gray-600">作業対象:</p>
                        <p id="current-work-order-info" class="font-bold text-xl text-indigo-600"></p>
                    </div>
                    <section class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-700 mb-2">チェック対象の選択</h2>
                        <div class="flex items-center space-x-2 mb-3">
                            <label for="mngIdInput" class="text-gray-600 whitespace-nowrap">管理番号:</label>
                            <input type="number" id="mngIdInput" placeholder="例: 123" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <select id="productSelector" class="w-full p-3 border border-gray-300 rounded-lg bg-white"></select>
                        <div class="bg-gray-50 p-4 rounded-lg border mt-3">
                            <p class="text-gray-600">品名: <span id="displayProductName" class="font-bold text-xl text-blue-600"></span></p>
                            <p class="text-gray-600 mt-1">産地: <span id="displayOrigin" class="font-semibold text-gray-800"></span></p>
                            <p class="text-gray-600 mt-1">JAN: <span id="displayJanCode" class="font-semibold text-gray-800"></span></p>
                        </div>
                    </section>
                    <section class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-700 mb-2">ラベル撮影</h2>
                        <input type="file" accept="image/*" capture="environment" id="cameraInput">
                        <button id="takePictureBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            ラベルを撮影する
                        </button>
                        <div class="mt-4 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center" id="imagePreviewContainer">
                            <img id="imagePreview" src="" class="hidden max-w-full mx-auto rounded-md" alt="撮影したラベルのプレビュー">
                            <p id="imagePlaceholder" class="text-gray-400">ここに撮影した画像が表示されます</p>
                        </div>
                    </section>
                    <section id="startCheckSection" class="mb-6">
                         <button id="startCheckBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:bg-gray-300 flex items-center justify-center" disabled>
                            <span id="buttonText">判定を開始する</span>
                            <div id="loadingSpinner" class="spinner hidden ml-2"></div>
                        </button>
                    </section>
                    <section id="resultSection" class="hidden">
                        <div id="resultSuccess" class="hidden bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md" role="alert">
                            <p class="font-bold text-2xl">一致しました (OK)</p>
                            <p>ラベルは正しいです。</p>
                        </div>
                        <div id="resultError" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
                            <p class="font-bold text-2xl">不一致 (NG)</p>
                            <p>ラベルが違う可能性があります！</p>
                        </div>
                        <p id="saveStatus" class="text-center mt-2 font-semibold"></p>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <div id="statusModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md">
            <h3 class="text-xl font-bold text-center mb-4">処理状況</h3>
            <ul id="statusLog" class="space-y-2 text-gray-700"></ul>
            <button id="closeModalBtn" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                閉じる
            </button>
        </div>
    </div>

    <script type="module">
        // Firebaseの初期化はheadタグ内の /__/firebase/init.js で自動的に行われます
        
        document.addEventListener('DOMContentLoaded', () => {
            const pageWorkList = document.getElementById('page-work-list');
            const pageLabelCheck = document.getElementById('page-label-check');
            const workListContainer = document.getElementById('work-list-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const backToListBtn = document.getElementById('back-to-list-btn');
            const currentDateEl = document.getElementById('current-date');
            const dbStatusIndicator = document.getElementById('db-status-indicator');
            const currentWorkOrderInfo = document.getElementById('current-work-order-info');
            const productSelector = document.getElementById('productSelector');
            const mngIdInput = document.getElementById('mngIdInput');
            const displayProductName = document.getElementById('displayProductName');
            const displayOrigin = document.getElementById('displayOrigin');
            const displayJanCode = document.getElementById('displayJanCode');
            const cameraInput = document.getElementById('cameraInput');
            const takePictureBtn = document.getElementById('takePictureBtn');
            const imagePreview = document.getElementById('imagePreview');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const startCheckSection = document.getElementById('startCheckSection');
            const startCheckBtn = document.getElementById('startCheckBtn');
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultSection = document.getElementById('resultSection');
            const resultSuccess = document.getElementById('resultSuccess');
            const resultError = document.getElementById('resultError');
            const saveStatus = document.getElementById('saveStatus');
            const statusModal = document.getElementById('statusModal');
            const statusLog = document.getElementById('statusLog');
            const closeModalBtn = document.getElementById('closeModalBtn');

            let isChecking = false;
            let currentWorkOrder = null;
            let currentLogItem = null;
            let userId = null;
            let db = null;
            let auth = null;
            let PRODUCTS = [];
            let WORK_ORDERS = [];

            const showPage = (pageToShow) => { pageWorkList.classList.add('hidden'); pageLabelCheck.classList.add('hidden'); pageToShow.classList.remove('hidden'); };
            const displayCurrentDate = () => {
                const today = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                currentDateEl.textContent = new Intl.DateTimeFormat('ja-JP-u-ca-japanese', options).format(today);
            };

            const renderWorkList = () => {
                workListContainer.innerHTML = '';
                if (WORK_ORDERS.length === 0) return;

                WORK_ORDERS.forEach(order => {
                    const product = PRODUCTS.find(p => p.id === order.productId);
                    if (!product) {
                        console.warn(`作業指示(ID: ${order.orderId})に対応する商品(ID: ${order.productId})が見つかりません。`);
                        return;
                    }
                    const statusColor = order.status === '作業中' ? 'bg-yellow-200' : 'bg-gray-200';
                    const item = document.createElement('div');
                    item.className = 'p-4 border rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 transition-colors';
                    item.dataset.orderId = order.orderId;
                    item.innerHTML = `<div class="flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">${product.name}</h3><span class="px-2 py-1 text-sm font-semibold rounded-full ${statusColor}">${order.status}</span></div><p class="text-gray-600 mt-1">数量: ${order.caseQuantity} ケース</p>`;
                    workListContainer.appendChild(item);
                });
            };

            const populateProductSelector = () => {
                productSelector.innerHTML = '';
                PRODUCTS.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.mngId}: ${product.name}`;
                    productSelector.appendChild(option);
                });
            };

            const updateCheckTarget = (productId) => {
                const selectedProduct = PRODUCTS.find(p => p.id === productId);
                if (selectedProduct) {
                    displayProductName.textContent = selectedProduct.name;
                    displayOrigin.textContent = selectedProduct.origin;
                    displayJanCode.textContent = selectedProduct.jan;
                    if (document.activeElement !== mngIdInput) { mngIdInput.value = selectedProduct.mngId; }
                }
            };

            const resetUIForNextCheck = () => {
                try {
                    buttonText.textContent = '判定を開始する';
                    loadingSpinner.classList.add('hidden');
                    startCheckBtn.classList.remove('is-checking');
                    startCheckBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    isChecking = false;
                    startCheckBtn.disabled = true;
                    imagePreview.src = '';
                    imagePreview.classList.add('hidden');
                    imagePlaceholder.classList.remove('hidden');
                    cameraInput.value = '';
                    takePictureBtn.disabled = false;
                } catch (e) { console.error("UIのリセット中にエラーが発生しました:", e); }
            };
            
            const showStatusModal = () => statusModal.classList.remove('hidden');
            const hideStatusModal = () => statusModal.classList.add('hidden');
            const logStatus = (message, isFinal = false) => {
                if (currentLogItem && !isFinal) {
                    currentLogItem.innerHTML += ' <span class="text-green-500 font-semibold">✔️ 完了</span>';
                }
                const newItem = document.createElement('li');
                newItem.textContent = message;
                statusLog.appendChild(newItem);
                currentLogItem = newItem;
            };

            async function loadDataFromFirestore() {
                try {
                    loadingIndicator.classList.remove('hidden');
                    workListContainer.classList.add('hidden');
                    
                    const productsSnapshot = await firebase.firestore().collection("products").get();
                    PRODUCTS = productsSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    
                    const workOrdersSnapshot = await firebase.firestore().collection("work_orders").get();
                    WORK_ORDERS = workOrdersSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));

                    if (WORK_ORDERS.length === 0) {
                        loadingIndicator.textContent = '作業指示がありません。';
                    } else {
                        loadingIndicator.classList.add('hidden');
                        workListContainer.classList.remove('hidden');
                    }

                    populateProductSelector();
                    renderWorkList();
                    displayCurrentDate();
                    showPage(pageWorkList);

                } catch(error) {
                    console.error("Firestoreからのデータ読み込みエラー:", error);
                    loadingIndicator.textContent = 'データの読み込みに失敗しました。';
                    throw error;
                }
            }
            
            // --- ★★★ 変更点 ★★★ ---
            // AI解析関数を、安全なCloud Functionを呼び出すように変更
            async function analyzeLabelWithAI(base64ImageData) {
                const analyzeLabel = firebase.functions().httpsCallable('analyzeLabel');
                try {
                    logStatus('AIに画像を送信中です...');
                    const result = await analyzeLabel({ imageData: base64ImageData });
                    logStatus('AIがラベルの文字を解析しています...');
                    // Cloud Functionからの返り値は result.data の中にあります
                    const recognizedText = result.data.recognizedText; 
                    if (!recognizedText) {
                        throw new Error("AIがテキストを認識できませんでした。");
                    }
                    return recognizedText;
                } catch (error) {
                    console.error("Cloud Functionの呼び出しに失敗:", error);
                    throw new Error("AI解析サーバーとの通信に失敗しました。");
                }
            }
            // --- ★★★ 変更点ここまで ★★★ ---

            async function main() {
                try {
                    db = firebase.firestore();
                    auth = firebase.auth();
                    
                    dbStatusIndicator.textContent = 'データベース接続: 正常';
                    dbStatusIndicator.classList.add('text-green-600');
                    
                    await auth.signInAnonymously();
                    auth.onAuthStateChanged(user => { if (user) { userId = user.uid; } });

                    await loadDataFromFirestore();

                    workListContainer.addEventListener('click', (event) => {
                        const item = event.target.closest('[data-order-id]');
                        if (item) {
                            currentWorkOrder = WORK_ORDERS.find(o => o.orderId === item.dataset.orderId);
                            if (currentWorkOrder) {
                                const product = PRODUCTS.find(p => p.id === currentWorkOrder.productId);
                                if (!product) { alert("エラー: 作業指示に対応する商品が見つかりません。"); return; }
                                currentWorkOrderInfo.textContent = `${product.name} (${currentWorkOrder.caseQuantity} ケース)`;
                                productSelector.value = currentWorkOrder.productId;
                                updateCheckTarget(currentWorkOrder.productId);
                                resultSection.classList.add('hidden');
                                saveStatus.textContent = '';
                                imagePreview.src = '';
                                imagePreview.classList.add('hidden');
                                imagePlaceholder.classList.remove('hidden');
                                startCheckBtn.disabled = true;
                                takePictureBtn.disabled = false;
                                showPage(pageLabelCheck);
                            }
                        }
                    });

                    backToListBtn.addEventListener('click', () => { showPage(pageWorkList); currentWorkOrder = null; });
                    mngIdInput.addEventListener('input', (event) => {
                        let value = event.target.value;
                        if (value.length >= 3) {
                            const paddedId = value.padStart(4, '0');
                            const foundProduct = PRODUCTS.find(p => p.mngId === paddedId);
                            if (foundProduct) { productSelector.value = foundProduct.id; updateCheckTarget(foundProduct.id); mngIdInput.classList.remove('border-red-500'); } 
                            else { mngIdInput.classList.add('border-red-500'); }
                        } else { mngIdInput.classList.remove('border-red-500'); }
                    });
                    productSelector.addEventListener('change', (event) => { updateCheckTarget(event.target.value); });
                    takePictureBtn.addEventListener('click', () => { cameraInput.click(); });
                    
                    cameraInput.addEventListener('change', (event) => { 
                        const file = event.target.files[0]; 
                        if (file) { 
                            const reader = new FileReader(); 
                            reader.onload = (e) => { 
                                imagePreview.src = e.target.result; 
                                imagePreview.classList.remove('hidden'); 
                                imagePlaceholder.classList.add('hidden'); 
                                startCheckBtn.disabled = false;
                                takePictureBtn.disabled = true;
                                resultSection.classList.add('hidden');
                                saveStatus.textContent = '';
                                setTimeout(() => { startCheckSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
                            }; 
                            reader.readAsDataURL(file); 
                        } 
                    });
                    closeModalBtn.addEventListener('click', hideStatusModal);

                    const saveCheckResult = async (checkData) => {
                        try {
                            await db.collection("check_logs").add({ ...checkData, checkedAt: firebase.firestore.FieldValue.serverTimestamp(), userId: userId });
                            return true;
                        } catch (error) {
                            console.error("Firestoreへのチェック結果の保存に失敗しました:", error);
                            return false;
                        }
                    };

                    startCheckBtn.addEventListener('click', async () => {
                        if (isChecking) { showStatusModal(); return; }
                        if (!imagePreview.src || !currentWorkOrder) return;
                        
                        isChecking = true;
                        statusLog.innerHTML = '';
                        currentLogItem = null;
                        buttonText.textContent = '判定中...';
                        loadingSpinner.classList.remove('hidden');
                        startCheckBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        startCheckBtn.classList.add('is-checking');
                        showStatusModal();

                        try {
                            let checkResult = 'NG';
                            
                            const selectedProductId = productSelector.value;
                            const selectedProduct = PRODUCTS.find(p => p.id === selectedProductId);
                            if (!selectedProduct) throw new Error("選択された商品が見つかりません。");

                            logStatus('画像の準備をしています...');
                            const base64ImageData = imagePreview.src.split(',')[1];
                            
                            // --- ★★★ 変更点 ★★★ ---
                            // 新しいAI関数を呼び出す
                            const recognizedText = await analyzeLabelWithAI(base64ImageData);
                            // --- ★★★ 変更点ここまで ★★★ ---

                            logStatus('判定結果を比較しています...');
                            const isProductNameOk = recognizedText.includes(selectedProduct.name);
                            const isOriginOk = recognizedText.includes(selectedProduct.origin);
                            const isJanOk = recognizedText.includes(selectedProduct.jan);
                            
                            resultSection.classList.remove('hidden');
                            if (isProductNameOk && isOriginOk && isJanOk) {
                                resultSuccess.classList.remove('hidden'); resultError.classList.add('hidden'); checkResult = 'OK';
                            } else {
                                resultError.classList.remove('hidden'); resultSuccess.classList.add('hidden');
                            }

                            const wasSaveSuccessful = await saveCheckResult({
                                workOrderId: currentWorkOrder.orderId, productId: selectedProduct.id,
                                productName: selectedProduct.name, result: checkResult, recognizedText: recognizedText,
                            });

                            if (wasSaveSuccessful) {
                                saveStatus.textContent = '✓ 結果をデータベースに保存しました。';
                                saveStatus.className = 'text-center mt-2 font-semibold text-green-600';
                            } else {
                                saveStatus.textContent = '✗ 結果のデータベースへの保存に失敗しました。';
                                saveStatus.className = 'text-center mt-2 font-semibold text-red-600';
                            }
                            
                            logStatus('判定が完了しました。「閉じる」を押してください。', true);

                        } catch (error) {
                            console.error("判定処理でエラーが発生しました:", error);
                            resultError.classList.remove('hidden');
                            resultSuccess.classList.add('hidden');
                            saveStatus.textContent = `判定エラー: ${error.message}`;
                            saveStatus.className = 'text-center mt-2 font-semibold text-red-600';
                            if (currentLogItem) { currentLogItem.innerHTML += ` <span class="text-red-500 font-semibold">❌ エラー</span>`; }
                        } finally {
                            resetUIForNextCheck();
                        }
                    });

                } catch (e) {
                    console.error("Firebaseの初期化またはデータ読み込みに失敗:", e);
                    dbStatusIndicator.textContent = 'データベース接続: エラー';
                    dbStatusIndicator.classList.add('text-red-600');
                    loadingIndicator.textContent = `データベースに接続できませんでした: ${e.message}`;
                }
            }
            
            main();
        });
    </script>
</body>
</html>
